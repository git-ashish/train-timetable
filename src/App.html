<div>
	<svg {width} {height} ref:svg>
		{#await promise}
			<text>loading stations...</text>
		{:then data}
			<text x="200" y="200" style="fill: white;">{Math.round(Math.floor($elapsed / 60))}:{Math.round($elapsed % 60) < 10 ? '0' : ''}{Math.round($elapsed % 60)}</text>
			<Legs {width} {height} x={data.x} y={data.y} elapsed={$elapsed} />
			<Stations stations={data.stations} {width} {height} x={data.x} y={data.y} />
			<!-- <Trips trips={data.trips} {width} {height} x={data.x} y={data.y} elapsed={$elapsed} /> -->
		{/await}
	</svg>
</div>

<style>
	h1 {
		color: purple;
	}
</style>

<script>
	import { csv } from 'd3-fetch'
	import { extent } from 'd3-array'
	import { scaleLinear } from 'd3-scale'
	import store from './store.js'
	import { select, mouse} from 'd3-selection'


	const dist = (from, to) => Math.sqrt(Math.pow(to[0] - from[0], 2) + Math.pow(to[1] - from[1], 2))

	const pathString = (from, to) => {
		const angle = (Math.PI * 0.5) + Math.atan2(to[1] - from[1], to[0] - from[0])
		const dst = dist(from, to)

		const cx = ((from[0] + to[0]) / 2) + (Math.cos(angle) * dst * 0.15)
		const cy = ((from[1] + to[1]) / 2) + (Math.sin(angle) * dst * 0.15)

		return `M${from[0]} ${from[1]} Q ${cx} ${cy} ${to[0]} ${to[1]}`
	}

	export default {
		store: () => store,
		oncreate() {
			
			// from: https://stackoverflow.com/questions/19764018/controlling-fps-with-requestanimationframe
			var stop = false;
			var frameCount = 0;
			var fps, fpsInterval, startTime, now, then, elapsed;

			function startAnimating(fps) {
					fpsInterval = 1000 / fps
					then = Date.now()
					startTime = then
					animate()
			}

			function animate() {
				requestAnimationFrame(animate)

				now = Date.now()
				elapsed = now - then

				if (elapsed > fpsInterval) {
						then = now - (elapsed % fpsInterval)

						store.set({ elapsed: (store.get().elapsed + 1) % 1440 })
				}
			}

			startAnimating(20)
		},
		onupdate() {
			// select('svg')
			// 	.on('mousemove', () => this.store.set({
			// 		elapsed: 0 + (mouse(this.refs.svg)[0] / 1000) * (720 - 0)
			// 	}))
		},
		data: () => ({
			width: window.innerHeight,
			height: window.innerHeight,
			promise: Promise.all([
				'./data/stations.csv',
				'./data/legs.csv',
				'./data/data.csv'
			].map(d => csv(d)))
				.then(results => {
					const stations = results[0]
						.filter(d => !d['full-name'].toLowerCase().includes('grens'))
						.map(d => ({
							...d,
							lat: +d.lat,
							lon: +d.lon
						}))

					const x = scaleLinear()
						.domain(extent(stations, d => d.lon))
						.range([10, window.innerHeight - 10])

					const y = scaleLinear()
						.domain(extent(stations, d => d.lat))
						.range([2 * window.innerHeight - 10, 10])

					const legs = results[1].map(d => ({
						...d,
						'tarif-unit': +d['tarif-unit'],
						ix: +d.ix,
						from: stations.find(s => s['short-name'] === d.from),
						to: stations.find(s => s['short-name'] === d.to),
					}))
					.map(d => ({
						...d,
						pathString: pathString([x(d.from.lon), y(d.from.lat)], [x(d.to.lon), y(d.to.lat)]), 
					}))

					const trips = results[2].map(d => ({
						...d,
						arrive: +d.arrive % 1440,
						depart: +d.depart % 1440,
						leg: legs.find((l, i) => i === +d['leg-index']),
						'train-id': +d['train-id'],
						serie: Math.round(+d['train-id'] / 100) * 100,
						'leg-index': +d['leg-index'],
						'trip-id': +d['trip-id'],
					}))
					
					// .filter(d => [1400, 14000, 5700, 7400, 6000, 5600, 2900, 6900, 3000, 8800, 3100, 11700, 2800, 6500, 5500, 3500, 1700, 7300, 2000, 500, 600, 4900, 14900, 3900, 800, 28300, 2100, 900, 1800, 7000, 3200, 4000, 8900, 3600, 6100, 11800, 7500, 5000, 700, 5800, 6600, 15000, 21400, 0, 23400, 22400].includes(d['serie']))
					// .filter(d => ['ut', 'asd', 'rtd', 'zl', 'zp'].includes(d.leg.from['short-name']) || ['ut', 'asd', 'rtd', 'zl', 'zp'].includes(d.leg.to['short-name']))
					// .filter(d => 100 * Math.floor(d['train-id'] / 100) === 3900)
					// console.log([...new Set(trips.filter(d => ['ut'].includes(d.leg.from['short-name']) || ['ut'].includes(d.leg.to['short-name'])).map(d => d['serie']))])
					// console.log(trips.filter(d => 768 >= d.depart && d.arrive >= 768))

					// console.log(stations, legs, trips)

					store.set({
						stations,
						legs,
						trips
					})


					console.log('STORE', store.get())

					return {
						stations,
						legs,
						trips,
						x,
						y
					}
			})
			// promise: new Promise(resolve => {
			// 	csv('./data/stations.csv', row => ({
			// 		...row,
			// 		lat: +row.lat,
			// 		lon: +row.lon
			// 	}))
			// 		.then(data => {
			// 			console.log(data)
			// 			resolve(data)
			// 		})
			// }),
		}),
		components: {
			Stations: './Stations.svelte',
			Legs: './Legs.svelte',
			Trips: './Trips.svelte'
		}
	}
</script>