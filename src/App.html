<div>
	<svg {width} {height} ref:svg>
		{#await promise}
			<text>loading stations...</text>
		{:then data}
			<text x="200" y="200" style="fill: white;">{Math.round(Math.floor($elapsed / 60))}:{Math.round($elapsed % 60) < 10 ? '0' : ''}{Math.round($elapsed % 60)}</text>
			<Legs legs={data.legs} trips={data.trips} {width} {height} x={data.x} y={data.y} elapsed={$elapsed} />
			<Stations stations={data.stations} {width} {height} x={data.x} y={data.y} />
			<!-- <Trips trips={data.trips} {width} {height} x={data.x} y={data.y} elapsed={$elapsed} /> -->
		{/await}
	</svg>
</div>

<style>
	h1 {
		color: purple;
	}
</style>

<script>
	import { csv } from 'd3-fetch'
	import { extent } from 'd3-array'
	import { scaleLinear } from 'd3-scale'
	import store from './store.js'
	import { select, mouse} from 'd3-selection'

	export default {
		store: () => store,
		onupdate() {
			select('svg')
				.on('mousemove', () => this.store.set({
					elapsed: 0 + (mouse(this.refs.svg)[0] / 1000) * (720 - 0)
				}))

		},
		data: () => ({
			width: 1000,
			height: 2000,
			promise: Promise.all([
				'./data/stations.csv',
				'./data/legs.csv',
				'./data/data.csv'
			].map(d => csv(d)))
				.then(results => {
					const stations = results[0]
						.filter(d => !d['full-name'].toLowerCase().includes('grens'))
						.map(d => ({
							...d,
							lat: +d.lat,
							lon: +d.lon
						}))

				const legs = results[1].map(d => ({
					...d,
					'tarif-unit': +d['tarif-unit'],
					ix: +d.ix,
					from: stations.find(s => s['short-name'] === d.from),
					to: stations.find(s => s['short-name'] === d.to)
				}))

				const trips = results[2].map(d => ({
					...d,
					arrive: +d.arrive % 1440,
					depart: +d.depart % 1440,
					leg: legs.find((l, i) => i === +d['leg-index']),
					'train-id': +d['train-id'],
					serie: Math.round(+d['train-id'] / 100) * 100,
					'leg-index': +d['leg-index'],
					'trip-id': +d['trip-id'],
				}))
				// .filter(d => [713, 14614, 1815, 14616, 14618, 14617, 14620, 14619, 14622, 14621, 14624, 14623, 14626, 14625, 14628, 14627, 14630, 14629, 14632, 14631, 14634, 14633, 14636, 14635, 14638, 14637, 14640, 14639, 14642, 14641, 14644, 14643, 14646, 14645, 14648, 14647, 14650, 14649, 14652, 14651, 14654, 14653, 14656, 14655, 14658, 14657, 14660, 14659, 14662, 14661, 14664, 14663, 14666, 14665, 14668, 14667, 14670, 14669, 14672, 14671, 14674, 14673, 14676, 14675, 14678, 14677, 14680, 14679, 14682, 14681, 14684, 14683, 14686, 14685, 14688, 12690].includes(d['train-id']))
				// .filter(d => ['ut', 'asd', 'rtd', 'zl', 'zp'].includes(d.leg.from['short-name']) || ['ut', 'asd', 'rtd', 'zl', 'zp'].includes(d.leg.to['short-name']))
				// .filter(d => 100 * Math.floor(d['train-id'] / 100) === 3900)
				console.log([...new Set(trips.filter(d => ['dt'].includes(d.leg.from['short-name']) || ['dt'].includes(d.leg.to['short-name'])).map(d => d['train-id']))])
				console.log(trips.filter(d => 768 >= d.depart && d.arrive >= 768))

				const x = scaleLinear()
					.domain(extent(stations, d => d.lon))
					.range([0, 1000])

				const y = scaleLinear()
					.domain(extent(stations, d => d.lat))
					.range([2000, 0])

				// console.log(stations, legs, trips)

				store.set({
					stations,
					legs,
					trips
				})

				console.log('STORE', store.get())

				return {
					stations,
					legs,
					trips,
					x,
					y
				}
			})
			// promise: new Promise(resolve => {
			// 	csv('./data/stations.csv', row => ({
			// 		...row,
			// 		lat: +row.lat,
			// 		lon: +row.lon
			// 	}))
			// 		.then(data => {
			// 			console.log(data)
			// 			resolve(data)
			// 		})
			// }),
		}),
		components: {
			Stations: './Stations.svelte',
			Legs: './Legs.svelte',
			Trips: './Trips.svelte'
		}
	}
</script>